generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model User {
  id        Int      @id @default(autoincrement())
  email     String   @unique
  nombre    String
  password  String
  role      String   @default("CAJERO")
  createdAt DateTime @default(now())

  logs  AuditLog[]
  sales Sale[]
}

model Flavor {
  id       Int       @id @default(autoincrement())
  nombre   String
  color    String?
  activo   Boolean   @default(true)
  products Product[]
}

model ProductType {
  id       Int       @id @default(autoincrement())
  nombre   String
  activo   Boolean   @default(true)
  products Product[]
}

model Product {
  id           Int     @id @default(autoincrement())
  sku          String? @unique
  tipoId       Int
  saborId      Int
  presentacion String
  precio       Float
  costo        Float
  foto         String?
  stock        Int     @default(0)
  activo       Boolean @default(true)

  recipe     Recipe?
  tipo       ProductType             @relation(fields: [tipoId], references: [id])
  sabor      Flavor                  @relation(fields: [saborId], references: [id])
  items      SaleItem[]
  stockMoves FinishedStockMovement[]
}

model Unit {
  id       Int           @id @default(autoincrement())
  nombre   String        @unique
  materias RawMaterial[]
}

model RawMaterial {
  id        Int    @id @default(autoincrement())
  nombre    String
  unidadId  Int
  stock     Float  @default(0)
  costoProm Float  @default(0)

  unidad      Unit                  @relation(fields: [unidadId], references: [id])
  movimientos RawMaterialMovement[]
  recipeItems RecipeItem[]
}

model RawMaterialMovement {
  id         Int      @id @default(autoincrement())
  materialId Int
  tipo       String
  cantidad   Float
  costoTotal Float
  createdAt  DateTime @default(now())

  material RawMaterial @relation(fields: [materialId], references: [id])
}

model FinishedStockMovement {
  id         Int      @id @default(autoincrement())
  productId  Int
  tipo       String
  cantidad   Int
  referencia String?
  createdAt  DateTime @default(now())

  product Product @relation(fields: [productId], references: [id])
}

model Recipe {
  id        Int          @id @default(autoincrement())
  productId Int          @unique
  items     RecipeItem[]

  product Product @relation(fields: [productId], references: [id])
}

model RecipeItem {
  id         Int   @id @default(autoincrement())
  recipeId   Int
  materialId Int
  cantidad   Float

  recipe   Recipe      @relation(fields: [recipeId], references: [id])
  material RawMaterial @relation(fields: [materialId], references: [id])
}

model Sale {
  id         Int      @id @default(autoincrement())
  folio      String   @unique
  fecha      DateTime @default(now())
  cajeroId   Int
  total      Float
  pagoMetodo String

  items  SaleItem[]
  pagos  Payment[]
  cajero User       @relation(fields: [cajeroId], references: [id])

  @@index([fecha], map: "sale_fecha_idx")
}

model SaleItem {
  id        Int   @id @default(autoincrement())
  saleId    Int
  productId Int
  cantidad  Int
  precio    Float

  sale    Sale    @relation(fields: [saleId], references: [id])
  product Product @relation(fields: [productId], references: [id])
}

model Payment {
  id        Int      @id @default(autoincrement())
  saleId    Int
  monto     Float
  metodo    String
  createdAt DateTime @default(now())

  sale Sale @relation(fields: [saleId], references: [id])
}

model CashBox {
  id          Int            @id @default(autoincrement())
  nombre      String
  tipo        String
  movimientos CashMovement[]
}

model CashMovement {
  id        Int      @id @default(autoincrement())
  cashBoxId Int
  tipo      String
  concepto  String
  monto     Float
  fecha     DateTime @default(now())

  cashBox CashBox @relation(fields: [cashBoxId], references: [id])

  @@index([cashBoxId], map: "cashmovement_cashbox_idx")
  @@index([fecha], map: "cashmovement_fecha_idx")
}

model Customer {
  id       Int     @id @default(autoincrement())
  nombre   String
  telefono String?
  limite   Float   @default(0)
  saldo    Float   @default(0)
  estado   String  @default("activo")

  creditos     Credit[]
  pagares      PromissoryNote[]
  asignaciones FridgeAssignment[]
}

model Credit {
  id         Int      @id @default(autoincrement())
  customerId Int
  saldo      Float
  createdAt  DateTime @default(now())

  pagos    CreditPayment[]
  customer Customer        @relation(fields: [customerId], references: [id])

  @@index([customerId], map: "credit_customer_idx")
}

model CreditPayment {
  id       Int      @id @default(autoincrement())
  creditId Int
  monto    Float
  fecha    DateTime @default(now())

  credit Credit @relation(fields: [creditId], references: [id])
}

model PromissoryNote {
  id         Int      @id @default(autoincrement())
  customerId Int
  monto      Float
  fecha      DateTime @default(now())
  estado     String   @default("vigente")

  customer Customer @relation(fields: [customerId], references: [id])
}

model FridgeAsset {
  id           Int                @id @default(autoincrement())
  modelo       String
  serie        String
  estado       String
  visitas      FridgeVisit[]
  asignaciones FridgeAssignment[]
}

model FridgeAssignment {
  id          Int      @id @default(autoincrement())
  assetId     Int
  customerId  Int
  ubicacion   String
  entregadoEn DateTime
  deposito    Float?
  renta       Float?

  asset    FridgeAsset @relation(fields: [assetId], references: [id])
  customer Customer    @relation(fields: [customerId], references: [id])
}

model FridgeVisit {
  id      Int      @id @default(autoincrement())
  assetId Int
  fecha   DateTime @default(now())
  notas   String?

  items FridgeVisitItem[]
  asset FridgeAsset       @relation(fields: [assetId], references: [id])
}

model FridgeVisitItem {
  id       Int    @id @default(autoincrement())
  visitId  Int
  product  String
  cantidad Int
  devuelto Int

  visit FridgeVisit @relation(fields: [visitId], references: [id])
}

model AuditLog {
  id        Int      @id @default(autoincrement())
  userId    Int?
  action    String
  modulo    String
  createdAt DateTime @default(now())

  user User? @relation(fields: [userId], references: [id])
}
