import { contextBridge, ipcRenderer } from 'electron';

/** ===== Tipos ===== */
export type Flavor = { id: number; nombre: string; color?: string | null; activo: boolean };

export type ProductType = { id: number; nombre: string; activo: boolean };

export type FinishedStockMovement = {
  id: number;
  productId: number;
  tipo: string;
  cantidad: number;
  referencia?: string | null;
  createdAt: string;
};

export type Product = {
  id: number;
  sku?: string | null;
  tipoId: number;
  saborId: number;
  presentacion: string;
  precio: number;
  costo: number;
  foto?: string | null;
  stock: number;
  activo: boolean;
  tipo: ProductType;
  sabor: Flavor;
};

export type CashMovement = {
  id: number;
  cashBoxId: number;
  tipo: string;
  concepto: string;
  monto: number;
  fecha: string;
};

export type CashBox = {
  id: number;
  nombre: string;
  tipo: string;
  movimientos: CashMovement[];
};

export type Customer = {
  id: number;
  nombre: string;
  telefono?: string | null;
  limite: number;
  saldo: number;
  estado: 'activo' | 'inactivo' | string;
};

export type PromissoryPayment = {
  id: number;
  promissoryNoteId: number;
  monto: number;
  fecha: string;
};

export type PromissoryNote = {
  id: number;
  customerId: number;
  monto: number;
  fecha: string;
  estado: string;
  abonos?: PromissoryPayment[];
};

/** ===== Refris / Asignaciones ===== */
export type FridgeAsset = {
  id: number;
  modelo: string;
  serie: string;
  estado: 'activo' | 'inactivo' | string;
  asignaciones?: FridgeAssignment[];
};

export type FridgeAssignment = {
  id: number;
  assetId: number;
  customerId: number;
  ubicacion: string;
  entregadoEn: string;
  fechaFin?: string | null;
  deposito?: number | null;
  renta?: number | null;

  // según el include del main
  asset?: FridgeAsset;
  customer?: Customer;
};

export type Unit = { id: number; nombre: string };

export type RawMaterialMovement = {
  id: number;
  materialId: number;
  tipo: string;
  cantidad: number;
  costoTotal: number;
  createdAt: string;
};

export type RawMaterial = {
  id: number;
  nombre: string;
  unidadId: number;
  stock: number;
  costoProm: number;
  unidad?: Unit;
  movimientos?: RawMaterialMovement[];
};

/** ===== API ===== */
const api = {
  // Backup
  exportarBackup: (destino: string) => ipcRenderer.invoke('backup:export', destino) as Promise<{ ok: boolean }>,

  // Catálogo
  listarCatalogo: () =>
    ipcRenderer.invoke('catalogo:listar') as Promise<{ sabores: Flavor[]; productos: Product[]; tipos: ProductType[] }>,

  crearTipo: (data: { nombre: string; activo?: boolean }) =>
    ipcRenderer.invoke('catalogo:crearTipo', data) as Promise<ProductType>,
  actualizarTipo: (data: { id: number; nombre: string; activo?: boolean }) =>
    ipcRenderer.invoke('catalogo:actualizarTipo', data) as Promise<ProductType>,
  toggleTipo: (data: { id: number; activo: boolean }) =>
    ipcRenderer.invoke('catalogo:toggleTipo', data) as Promise<ProductType>,

  crearSabor: (data: { nombre: string; color?: string; activo?: boolean }) =>
    ipcRenderer.invoke('catalogo:crearSabor', data) as Promise<Flavor>,
  actualizarSabor: (data: { id: number; nombre: string; color?: string | null; activo?: boolean }) =>
    ipcRenderer.invoke('catalogo:actualizarSabor', data) as Promise<Flavor>,
  toggleSabor: (data: { id: number; activo: boolean }) =>
    ipcRenderer.invoke('catalogo:toggleSabor', data) as Promise<Flavor>,

  crearProducto: (data: {
    tipoId: number;
    saborId: number;
    presentacion: string;
    precio: number;
    costo: number;
    sku?: string;
    stock?: number;
    activo?: boolean;
  }) => ipcRenderer.invoke('catalogo:crearProducto', data) as Promise<Product>,

  actualizarProducto: (data: {
    id: number;
    tipoId: number;
    saborId: number;
    presentacion: string;
    precio: number;
    costo: number;
    sku?: string | null;
    stock?: number;
    activo?: boolean;
  }) => ipcRenderer.invoke('catalogo:actualizarProducto', data) as Promise<Product>,

  toggleProducto: (data: { id: number; activo: boolean }) =>
    ipcRenderer.invoke('catalogo:toggleProducto', data) as Promise<Product>,

  // Cajas
  listarCajas: () => ipcRenderer.invoke('cajas:listarMovimientos') as Promise<CashBox[]>,
  crearMovimiento: (data: { cashBoxId: number; tipo: string; concepto: string; monto: number; fecha?: string }) =>
    ipcRenderer.invoke('cajas:crearMovimiento', data) as Promise<CashMovement>,

  // Clientes
  listarClientes: () => ipcRenderer.invoke('clientes:listar') as Promise<Customer[]>,
  crearCliente: (data: { nombre: string; telefono?: string; limite?: number; saldo?: number; estado?: 'activo' | 'inactivo' }) =>
    ipcRenderer.invoke('clientes:crear', data) as Promise<Customer>,
  actualizarCliente: (data: { id: number; nombre: string; telefono?: string; limite?: number; saldo?: number; estado?: 'activo' | 'inactivo' }) =>
    ipcRenderer.invoke('clientes:actualizar', data) as Promise<Customer>,
  toggleClienteEstado: (data: { id: number; estado: 'activo' | 'inactivo' }) =>
    ipcRenderer.invoke('clientes:toggleEstado', data) as Promise<Customer>,
  listarClientesConSaldo: () => ipcRenderer.invoke('creditos:listarConSaldo') as Promise<Customer[]>,

  listarPagaresPorCliente: (customerId: number) =>
    ipcRenderer.invoke('pagares:listarPorCliente', customerId) as Promise<(PromissoryNote & { abonos?: PromissoryPayment[] })[]>,
  crearPagare: (data: { customerId: number; monto: number }) =>
    ipcRenderer.invoke('pagares:crear', data) as Promise<PromissoryNote>,
  registrarAbonoPagare: (data: { promissoryNoteId: number; monto: number; cashBoxId?: number }) =>
    ipcRenderer.invoke('pagares:registrarAbono', data) as Promise<{ pagare: PromissoryNote & { abonos?: PromissoryPayment[] }; saldoCliente: number }>,

  // Asignaciones (cliente <-> refri)
  listarAsignacionesCliente: (customerId: number) =>
    ipcRenderer.invoke('asignaciones:listarPorCliente', customerId) as Promise<(FridgeAssignment & { asset: FridgeAsset })[]>,
  crearAsignacionRefri: (data: {
    customerId: number;
    assetId: number;
    ubicacion: string;
    entregadoEn: string;
    deposito?: number;
    renta?: number;
  }) => ipcRenderer.invoke('asignaciones:crear', data) as Promise<FridgeAssignment>,
  eliminarAsignacionRefri: (id: number) => ipcRenderer.invoke('asignaciones:eliminar', id) as Promise<{ ok: boolean }>,
  listarRefrisDisponibles: () => ipcRenderer.invoke('refris:listarDisponibles') as Promise<FridgeAsset[]>,

  // Refris
  listarRefris: () => ipcRenderer.invoke('refris:listar') as Promise<FridgeAsset[]>,
  crearRefri: (data: { modelo: string; serie: string; estado?: string }) =>
    ipcRenderer.invoke('refris:crear', data) as Promise<FridgeAsset>,
  actualizarRefri: (data: { id: number; modelo?: string; serie?: string; estado?: string }) =>
    ipcRenderer.invoke('refris:actualizar', data) as Promise<FridgeAsset>,
  toggleRefriEstado: (data: { id: number }) => ipcRenderer.invoke('refris:toggleEstado', data) as Promise<FridgeAsset>,

  // Ventas
  listarVentas: () => ipcRenderer.invoke('ventas:list') as Promise<unknown>,
  crearVenta: (data: { items: { productId: number; cantidad: number }[]; metodo: string; cajeroId?: number }) =>
    ipcRenderer.invoke('ventas:crear', data) as Promise<unknown>,
  ventaPOS: (data: { items: { productId: number; cantidad: number }[]; customerId?: number | null; cashBoxId?: number | null }) =>
    ipcRenderer.invoke('pos:venta', data) as Promise<{ saleId: number; folio: string; total: number; customerId: number | null }>,

  // Inventario (materia prima)
  listarMaterias: () =>
    ipcRenderer.invoke('inventario:listarMaterias') as Promise<{ materias: RawMaterial[]; unidades: Unit[] }>,
  crearUnidad: (data: { nombre: string }) => ipcRenderer.invoke('inventario:crearUnidad', data) as Promise<Unit>,
  crearMateria: (data: { nombre: string; unidadId: number; stock?: number; costoProm?: number }) =>
    ipcRenderer.invoke('inventario:crearMateria', data) as Promise<RawMaterial>,
  movimientoMateria: (data: { materialId: number; tipo: 'entrada' | 'salida'; cantidad: number; costoTotal?: number }) =>
    ipcRenderer.invoke('inventario:movimientoMateria', data) as Promise<RawMaterial>,

  // Inventario (productos terminados)
  listarProductosStock: () =>
    ipcRenderer.invoke('inventario:listarProductosStock') as Promise<(Product & { stockMoves?: FinishedStockMovement[] })[]>,
  movimientoProducto: (data: { productId: number; tipo: 'entrada' | 'salida'; cantidad: number; referencia?: string }) =>
    ipcRenderer.invoke('inventario:movimientoProducto', data) as Promise<Product>
} as const;

contextBridge.exposeInMainWorld('hedelmia', api);

declare global {
  interface Window {
    hedelmia: typeof api;
  }
}
